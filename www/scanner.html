<html>
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src * blob:; script-src * 'unsafe-eval' 'unsafe-inline' blob:; style-src * 'unsafe-inline'; media-src *; img-src 'self' data:">
    <meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover">
    <link rel="stylesheet" href="css/index.css">
    <script src="js/adapter.js"></script>
    <script src="js/utils.js"></script>
    <script type="text/javascript" src="cordova.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@8.6.3/dist/dbr.js"></script>
</head>
<body style="background-color:transparent;">
<div>
    <svg style="width:100%;height:100%;position:absolute;left:0;top:0;"> </svg>
    <video class="camera" muted autoplay="autoplay" playsinline="playsinline" webkit-playsinline style="z-index:-1;width:100%;height:100%;position:absolute;left:0;top:0;object-fit:fill;"></video>
    <select id="cameraselect" style="display:none;position:absolute;"></select>
    <style>
        .results-container {
            background: rgba(0,0,0,0.5);
            position:absolute;
            left:50%;
            bottom:0;
            width: 100%;
            height: 20%;
            transform:translate(-50%,0);
            text-align: center;
            color: white;
            text-shadow: 1px 1px black;
        }
        .barcode-polygon {
            fill:rgba(85,240,40,0.5);          
            stroke:green;
            stroke-width:1;
        }
    </style>
</div>
<div class="results-container">
    <pre id="results-pre">Result:
    </pre>
</div>
<script>
var frameWidth = 0;
var interval = null;
var decoding = false;
var initialized = false;
let reader = null;
var localStream;
var platform = "";
document.getElementById("cameraselect").onchange=onCameraChanged;
document.addEventListener('deviceready', onDeviceReady, false);
document.getElementsByClassName("camera")[0].addEventListener('loadeddata',onPlayed, false);

async function initDBR(){
    if (platform == "browser"){
        reader = await Dynamsoft.DBR.BarcodeReader.createInstance();
        onInit();
    }else{
        cordova.plugins.DBR.init("",onInit);
    }
}

function onInit(){
    initialized=true;
    var QRCodeTemplate="{\r\n  \"ImageParameter\": {\r\n    \"BarcodeFormatIds\": [\r\n      \"BF_QR_CODE\"\r\n    ],\r\n    \"BinarizationModes\": [\r\n      {\r\n        \"BlockSizeX\": 61,\r\n        \"BlockSizeY\": 61,\r\n        \"LibraryFileName\": \"\",\r\n        \"LibraryParameters\": \"\",\r\n        \"Mode\": \"BM_LOCAL_BLOCK\"\r\n      }\r\n    ],\r\n    \"Description\": \"\",\r\n    \"ExpectedBarcodesCount\": 1,\r\n    \"Name\": \"Settings\",\r\n    \"Timeout\": 99999\r\n  },\r\n  \"Version\": \"3.0\"\r\n}";
    alert("Using QR code template.")
    cordova.plugins.DBR.initRuntimeSettingsWithString(QRCodeTemplate,onInitSettings);
}

function onInitSettings(){
    console.log("settings inited");
}

function onDeviceReady() {
    // Cordova is now initialized. Have fun!
    //alert("device ready.");
    platform = initForPlatforms();
    if (platform == "browser"){
        loadDevices();
        document.getElementById("cameraselect").style.display = "";
    }
    
    if (platform != "iOS"){
        var canvas = document.createElement("canvas");
        canvas.style.display="none";
        canvas.id="hiddenCVS";
        document.body.appendChild(canvas);
    }
    initDBR();
    play();
}

function play(deviceId, HDUnsupported) {
    var constraints = {};
    if (platform == 'browser'){
        if (!!deviceId){
            constraints = {
                video: {deviceId: deviceId},
                audio: false
            }
        }else{
            constraints = {
                video: true,
                audio: false
            }
        }
    }
    else{
        var mode = "environment";
        constraints = {
            video: {
                facingMode: { exact: mode }
            },
            audio: false
        }
        if (!HDUnsupported){
            constraints.video.width = {exact: 1280};
            constraints.video.height = {exact: 720};
        }
    }
    
    
    //if (platform != 'browser'){
    //    constraints.video.width = { ideal: 720 };
    //    constraints.video.height = { ideal: 1280 };
    //    console.log(constraints);
    //}
    
    navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
        localStream = stream;
        var camera = document.getElementsByClassName("camera")[0];
        // Attach local stream to video element
        camera.srcObject = stream;

    }).catch(function(err) {
        console.error('getUserMediaError', err, err.stack);
        alert("getUserMediaError");
        alert(err.stack);
        if (!HDUnsupported){
            play(deviceId,true);
        }
    });
}

function loadDevices(){
    var cameraselect = document.getElementById("cameraselect");
    if (platform == "browser"){
        navigator.mediaDevices.enumerateDevices().then(async function(devices) {
            for (var i=0;i<devices.length;i++){
                var device = devices[i];
                if (device.kind == 'videoinput'){
                    var label = device.label;
                    cameraselect.add(new Option(label,device.deviceId));
                }
            }
        });
    }
}

function onCameraChanged(){
    var cameraselect = document.getElementById("cameraselect");
    var deviceId = cameraselect.selectedOptions[0].value;
    play(deviceId);
}

function startDecoding(){
    clearInterval(interval)
    //1000/25=40
    interval = setInterval(captureAndDecode, 80);
}

async function captureAndDecode(){
    var video = document.getElementsByClassName("camera")[0];
    if (initialized==true) {
        if (decoding==true){
            //Still decoding. Skip.
            return;
        }
        
        if (platform == "iOS"){
            video.render.save(function (data) {
                if (frameWidth==0){
                    getImgSizeAndUpdateSVGViewBox(data);
                }
                decoding=true;
                cordova.plugins.DBR.decode(data,onDecode);
            });
        }else {
            var base64 = captureFrame();
            if (platform == "Android"){
                decoding=true;
                cordova.plugins.DBR.decode(base64,onDecode);
            }else{
                decode(video);
            }
            
        }
    }
}

function captureFrame() {
    var cvs = document.getElementById("hiddenCVS");
    var camera = document.getElementsByClassName("camera")[0];
    cvs.width = camera.videoWidth;
    cvs.height = camera.videoHeight;
    cvs.getContext('2d').drawImage(camera, 0, 0, camera.videoWidth,camera.videoHeight);
    var dataURL = cvs.toDataURL('image/jpeg', 1.0); 
    var base64 = dataURL.replace("data:image/jpeg;base64,","");
    return base64;
}

function getImgSizeAndUpdateSVGViewBox(data){
    var img = document.createElement("img");
    img.src = "data:image/jpeg;base64,"+data;
    img.onload=function(){
        //alert(img.naturalWidth);
        //alert(img.naturalHeight);
        if (img.naturalWidth!=frameWidth){
            frameWidth = img.naturalWidth;
            updateSVGViewBox(img.naturalWidth,img.naturalHeight);
        }
    }
}


async function decode(data){
    decoding=true;
    var results = [];
    try{
        results = await reader.decode(data);
    }catch (ex){
        alert(ex);
        alert(ex.stack);
    }
    decoding=false;
    onFrameRead(results);
}

function onDecode(results){
    decoding=false;
    onFrameRead(results);
}

function onPlayed(){
    if (platform=="iOS"){
        console.log("iOS should wait for the video is resized.");
    }
    else{
        updateSVGViewBoxBasedOnVideoSize();
    }
    startDecoding();
}

function updateSVGViewBoxBasedOnVideoSize(){
    var camera = document.getElementsByClassName("camera")[0];
    updateSVGViewBox(camera.videoWidth,camera.videoHeight);
    frameWidth = camera.videoWidth;
    //alert("Video width: "+frameWidth);
}

function onFrameRead(results){
    var resultsPre = document.getElementById("results-pre");
    var content = "";
    if (results.length == 0) {
        content = ""; //No barcodes found
    } else
    {
        content = "Found "+ results.length+ " barcode(s)\n";
    }
    for(let i = 0; i < results.length; i++){
        content = content + results[i].barcodeText + "\n";
    }
    resultsPre.innerHTML = content+"\n";
    showOverlayOnSVG(results);
}

function updateSVGViewBox(width,height){
    var svg = document.getElementsByTagName("svg")[0];
    svg.setAttribute("viewBox","0 0 "+width+" "+height);
}

function showOverlayOnSVG(results){
    var svg = document.getElementsByTagName("svg")[0];
    svg.setAttribute("preserveAspectRatio","none");
    svg.innerHTML=""
    for(let i = 0; i < results.length; i++){
        var result = results[i];
        if ("x1" in result){
            var points = getPointsData(result);
        }else{
            var points = getPointsData(result.localizationResult);
        }
        var a = document.createElementNS("http://www.w3.org/2000/svg","a");
        var polygon = document.createElementNS("http://www.w3.org/2000/svg","polygon");
        polygon.setAttribute("points",points);
        polygon.setAttribute("class","barcode-polygon");
        a.append(polygon)
        svg.append(a);
    }
}

function getPointsData(lr){
    var pointsData = lr.x1+","+lr.y1 + " ";
    pointsData = pointsData+ lr.x2+","+lr.y2 + " ";
    pointsData = pointsData+ lr.x3+","+lr.y3 + " ";
    pointsData = pointsData+ lr.x4+","+lr.y4;
    return pointsData;
}

</script>
</body>
</html>

